{% extends "base.html" %}

{% block title %}Dashboard | Clinic Follow-up Tracker{% endblock %}

{% block content %}
  <div class="row">
    <div class="card">
      <div><strong>Summary</strong></div>
      <div class="muted">Clinic totals</div>
      <div>Total: {{ summary.total }}</div>
      <div>Pending: {{ summary.pending }}</div>
      <div>Done: {{ summary.done }}</div>
    </div>

    <div class="card" style="flex: 1; min-width: 320px;">
      <div class="row" style="justify-content: space-between; align-items: center;">
        <h2 style="margin: 0;">Follow-ups</h2>
        <div class="row" style="gap: 10px; align-items: center;">
          <a href="{% url 'followups_export_csv' %}?{{ qs_no_page }}">Export CSV</a>
          <a href="{% url 'followup_create' %}">+ New follow-up</a>
        </div>
      </div>

      <form method="get" class="row" style="align-items: end;">
        <div>
          <label>Status</label>
          <select name="status">
            <option value="" {% if not filters.status %}selected{% endif %}>All</option>
            <option value="pending" {% if filters.status == 'pending' %}selected{% endif %}>Pending</option>
            <option value="done" {% if filters.status == 'done' %}selected{% endif %}>Done</option>
          </select>
        </div>
        <div>
          <label>Due start</label>
          <input type="date" name="due_start" value="{{ filters.due_start }}" />
        </div>
        <div>
          <label>Due end</label>
          <input type="date" name="due_end" value="{{ filters.due_end }}" />
        </div>
        <div>
          <button style="background-color: rgb(183, 56, 71); color: white;" type="submit">Apply</button>
          <a class="muted" href="{% url 'dashboard' %}">Reset</a>
        </div>
      </form>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Patient</th>
              <th>Phone</th>
              <th>Due</th>
              <th>Status</th>
              <th>Lang</th>
              <th>Public link</th>
              <th>Views</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for f in followups %}
              <tr>
                <td>{{ f.patient_name }}</td>
                <td>{{ f.phone }}</td>
                <td>
                  {{ f.due_date }}
                  {% if f.is_overdue and f.status != 'done' %}
                    <span class="badge overdue" style="margin-left: 6px;">Overdue</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge {{ f.status }}">{{ f.get_status_display }}</span>
                </td>
                <td>{{ f.language }}</td>
                <td>
                  <a href="{% url 'public_followup' public_token=f.public_token %}" target="_blank">/p/{{ f.public_token }}/</a>
                </td>
                <td>{{ f.view_count }}</td>
                <td>
                  <a href="{% url 'followup_edit' pk=f.pk %}">Edit</a>
                  {% if f.status != 'done' %}
                    <form method="post" action="{% url 'followup_mark_done' pk=f.pk %}" style="display:inline;">
                      {% csrf_token %}
                      <button type="submit">Mark done</button>
                    </form>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="8" class="muted">No follow-ups found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if page_obj and page_obj.paginator.num_pages > 1 %}
        <div class="row" style="justify-content: space-between; align-items: center; margin-top: 10px;">
          <div class="muted">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </div>
          <div class="row" style="gap: 8px;">
            {% if page_obj.has_previous %}
              <a href="?{% if qs_no_page %}{{ qs_no_page }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
            {% else %}
              <span class="muted">Previous</span>
            {% endif %}

            {% if page_obj.has_next %}
              <a href="?{% if qs_no_page %}{{ qs_no_page }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
            {% else %}
              <span class="muted">Next</span>
            {% endif %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
